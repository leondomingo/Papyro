<?xml version="1.0" encoding="ISO-8859-1" ?>
<report>
    <name>Resumen mensual para profesores</name>
    <configuration>
        <paper>
            <size>A4</size>
            <margin>
                <left>15</left>
                <right>15</right>
                <top>15</top>
                <bottom>15</bottom>
            </margin>
            <orientation>portrait</orientation>
        </paper>
    </configuration>
    <font>
        <name>Helvetica</name>
        <size>10</size>
        <color>000000</color>
        <style>
        </style>
    </font>
    <params>
        <param name="P_PROFESOR" type="int">1</param>
        <param name="P_FECHA_INICIO" type="int">50</param>
        <param name="P_FECHA_FIN" type="int">50</param>        
    </params>
    <report_title>
        <id></id>
        <body></body>
    </report_title>
    <page>
        <id>page_1</id>
        <number>1</number>
        <body>
            <master>
                <id>master_grupos</id>
                <table>
                    <fields></fields>
                    <query>
                    SELECT
                        DISTINCT grupos.id as "GRUPOS_ID",
                        trim(grupos.nombre) as "GRUPOS_NOMBRE",
                        format_fecha('dd/mm/yyyy', grupos.fechainicio) as "GRUPOS_FECHAINICIO",
                        format_fecha('dd/mm/yyyy', grupos.fechafin) as "GRUPOS_FECHAFIN",
                        grupos.resumen_horario as "GRUPOS_RESUMENHORARIO",
                        grupos.horas_de_clase as "GRUPOS_HORASCLASE"
                    FROM grupos
                    JOIN clases_de_grupos on grupos.id = clases_de_grupos.id_grupos_grupo
                    JOIN calendarios on calendarios.id = clases_de_grupos.id_calendarios_fecha
                    WHERE
                        clases_de_grupos.id_personal_profesor = %(P_PROFESOR)s AND
                        calendarios.fecha &gt;= '%(P_FECHA_INICIO)s' AND
                        calendarios.fecha &lt;= '%(P_FECHA_FIN)s'
                    ORDER BY "GRUPOS_NOMBRE"
                    </query>
                </table>
                <body>
                    <text>
                        <id></id>
                        <value>#GRUPOS_NOMBRE# de #GRUPOS_FECHAINICIO# a #GRUPOS_FECHAFIN# (#GRUPOS_HORASCLASE# h)</value>
                    </text>
                    <!--<text>
                        <id></id>
                        <value>*#GRUPOS_RESUMENHORARIO#*</value>
                    </text>-->
                    <!--<text>
                        <id></id>
                        <value>    Horas de clase: #GRUPOS_HORASCLASE#</value>
                    </text>-->
                    <text>
                        <id></id>
                        <value>    Horarios</value>
                    </text>
                    <detail>
                        <id>detail_horarios</id>
                        <master_field>GRUPOS_ID</master_field>
                        <table>
                            <query>
                                SELECT
                                    horario_del_grupo.id as "HORARIOS_ID",
                                    resumen(horario_del_grupo.id) as "HORARIOS_RESUMEN",
                                    CASE WHEN lunes THEN 'L' ELSE '' END as "LUNES",
                                    CASE WHEN martes THEN 'M' ELSE '' END as "MARTES",
                                    CASE WHEN miercoles THEN 'X' ELSE '' END as "MIERCOLES",
                                    CASE WHEN jueves THEN 'J' ELSE '' END as "JUEVES",
                                    CASE WHEN viernes THEN 'V' ELSE '' END as "VIERNES",
                                    CASE WHEN sabado THEN 'S' ELSE '' END as "SABADO",
                                    CASE WHEN domingo THEN 'D' ELSE '' END as "DOMINGO",
                                    CASE WHEN horario_del_grupo.fechainicio &lt; '%(P_FECHA_INICIO)s'
                                        THEN '%(P_FECHA_INICIO)s'
                                        ELSE format_fecha('dd/mm/yyyy', horario_del_grupo.fechainicio)
                                    END as "HORARIOS_FECHAINICIO",
                                    CASE WHEN horario_del_grupo.fechafin &gt; '%(P_FECHA_FIN)s'
                                        THEN '%(P_FECHA_FIN)s'
                                        ELSE format_fecha('dd/mm/yyyy', horario_del_grupo.fechafin)
                                    END as "HORARIOS_FECHAFIN",                                    
                                    format_hora('hh:mm', horario_del_grupo.horainicio) as "HORARIOS_HORAINICIO",
                                    format_hora('hh:mm', horario_del_grupo.horafin) as "HORARIOS_HORAFIN",
                                    SUM(diferencia_en_horas(clases_de_grupos.horainicio, clases_de_grupos.horafin)) as "HORARIO_HORAS"                                
                                FROM horario_del_grupo
                                JOIN clases_de_grupos on horario_del_grupo.id = clases_de_grupos.id_horario_del_grupo_horario
                                JOIN calendarios on 
                                    calendarios.id = clases_de_grupos.id_calendarios_fecha AND
                                    calendarios.fecha &gt;= '%(P_FECHA_INICIO)s' AND
                                    calendarios.fecha &lt;= '%(P_FECHA_FIN)s'
                                WHERE
                                    horario_del_grupo.id_grupos_grupo = %(GRUPOS_ID)s AND
                                    horario_del_grupo.fechainicio &lt;= '%(P_FECHA_FIN)s' AND
                                    horario_del_grupo.fechafin &gt;= '%(P_FECHA_INICIO)s'
                                GROUP by
                                    "HORARIOS_ID",
                                    "HORARIOS_RESUMEN",
                                    "LUNES",
                                    "MARTES",
                                    "MIERCOLES",
                                    "JUEVES",
                                    "VIERNES",
                                    "SABADO",
                                    "DOMINGO",
                                    "HORARIOS_FECHAINICIO",
                                    "HORARIOS_FECHAFIN",
                                    "HORARIOS_HORAINICIO",
                                    "HORARIOS_HORAFIN"                                
                                ORDER BY "HORARIOS_FECHAINICIO"
                            </query>
                            <fields></fields>
                        </table>
                        <body>
                            <!--<text>
                                <id></id>
                                <value>      #HORARIO_HORAS#</value>
                            </text>-->                        
                            <text>
                                <id></id>
                                <value>      #HORARIOS_FECHAINICIO#-#HORARIOS_FECHAFIN#   #LUNES##MARTES##MIERCOLES##JUEVES##VIERNES##SABADO##DOMINGO# #HORARIOS_HORAINICIO#-#HORARIOS_HORAFIN# (#HORARIO_HORAS# h)</value>
                            </text>
                            <!--<text>
                                <id></id>
                                <value>      #HORARIOS_RESUMEN#</value>
                            </text>-->                        
                        </body>
                    </detail>
                    <text>
                        <id></id>
                        <value></value>
                    </text>
                    <text>
                        <id></id>
                        <value>    Alumnos</value>
                    </text>
                    <detail>
                        <id>detail_alumnos</id>
                        <master_field>GRUPOS_ID</master_field>
                        <table>
                            <query>
                                SELECT
                                    alias_alumno(alumnos.id) as "ALUMNOS_ALIAS",
                                    CASE WHEN aeg.fecha_inicio &lt; '%(P_FECHA_INICIO)s'
                                        THEN '%(P_FECHA_INICIO)s'
                                        ELSE format_fecha('dd/mm/yyyy', aeg.fecha_inicio)
                                    END as "AEG_FECHAINICIO",
                                    CASE WHEN aeg.fecha_fin &gt; '%(P_FECHA_FIN)s'
                                        THEN '%(P_FECHA_FIN)s'
                                        ELSE format_fecha('dd/mm/yyyy', aeg.fecha_fin)
                                    END as "AEG_FECHAFIN"
                                FROM alumnos
                                JOIN alumnos_en_grupos aeg on 
                                    alumnos.id = aeg.id_alumnos_alumno and
                                    aeg.id_grupos_grupo = %(GRUPOS_ID)d
                                ORDER BY "ALUMNOS_ALIAS"
                            </query>
                            <fields></fields>
                        </table>
                        <body>
                            <text>
                                <id></id>
                                <value>      #ALUMNOS_ALIAS# (#AEG_FECHAINICIO# - #AEG_FECHAFIN#)</value>
                            </text>
                        </body>
                    </detail>
                    <text>
                        <id></id>
                        <value></value>
                    </text>
                    <text>
                        <id></id>
                        <value>    Cancelaciones</value>
                    </text>
                    <detail>
                        <id>detail_cancelaciones</id>
                        <master_field>GRUPOS_ID</master_field>
                        <table>
                            <query>
                                SELECT
                                    format_fecha('dd/mm/yyyy', calendarios.fecha) as "CAL_FECHA",
                                    tipos_de_cancelacion.nombre as "TDC_NOMBRE",
                                    diferencia_en_horas(clases_de_grupos.horainicio, clases_de_grupos.horafin) as "CDG_HORAS"
                                FROM clases_de_grupos
                                JOIN calendarios on calendarios.id = clases_de_grupos.id_calendarios_fecha
                                JOIN tipos_de_cancelacion on 
                                    tipos_de_cancelacion.id = clases_de_grupos.id_tipos_de_cancelacion_tipo_de_cancelacion
                                WHERE
                                    clases_de_grupos.id_grupos_grupo = %(GRUPOS_ID)s AND 
                                    NOT tipos_de_cancelacion.clase_impartida AND
                                    calendarios.fecha &gt;= '%(P_FECHA_INICIO)s' AND
                                    calendarios.fecha &lt;= '%(P_FECHA_FIN)s'
                                ORDER BY calendarios.fecha
                            </query>
                            <fields></fields>
                        </table>
                        <body>
                            <text>
                                <id></id>
                                <value>      #CAL_FECHA# #TDC_NOMBRE# (#CDG_HORAS# h)</value>
                            </text>
                        </body>
                    </detail>
                    <text>
                        <id></id>
                        <value></value>
                    </text>
                </body>                
            </master>
        </body>
    </page>
</report>